import java.nio.file.Paths

plugins {
    id 'java'
    id 'application'
    id 'org.springframework.boot' version '3.4.5'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'gg.jte.gradle' version '3.2.1'
}

group = 'com.oway'
version = '0.0.1-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(24)
    }
}

repositories {
    mavenCentral()
    maven {
        url = uri("${System.getProperty('user.home')}/.m2/repository")
    }
    // Embabel releases
    maven {
        name = "embabel-releases"
        url = uri("https://repo.embabel.com/artifactory/libs-release")
        mavenContent {
            releasesOnly()
        }
    }

    // Embabel snapshots
    maven {
        name = "embabel-snapshots"
        url = uri("https://repo.embabel.com/artifactory/libs-snapshot")
        mavenContent {
            snapshotsOnly()
        }
    }
}

jte {
    sourceDirectory = Paths.get("src/main/jte")
    targetDirectory = Paths.get("${buildDir}/generated-sources/jte")
    contentType = gg.jte.ContentType.Html
    binaryStaticContent = true
    generate()  // This tells the plugin to generate during the build
}

// Make sure the generated sources are included in the compilation
sourceSets {
    main {
        java {
            srcDir "${buildDir}/generated-sources/jte"
        }
    }
}

// Ensure JTE generation happens before compilation
tasks.compileJava {
    dependsOn generateJte
}

// If you want the generated files in resources (matching your Maven config)
tasks.generateJte {
    doLast {
        copy {
            from "${buildDir}/generated-sources/jte"
            into "${buildDir}/resources/main"
        }
    }
}

dependencies {
    //Sprint Boot
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
    implementation 'jakarta.validation:jakarta.validation-api:3.1.1' // Or the latest version
    implementation("com.fasterxml.jackson.datatype:jackson-datatype-hibernate6:2.19.0")
    implementation 'org.springframework.boot:spring-boot-starter-webflux'

    implementation("com.graphhopper:jsprit-core:1.9.0-beta.12")
    implementation 'com.fasterxml.jackson.dataformat:jackson-dataformat-csv:2.17.0'

    implementation("gg.jte:jte:3.2.1")
    runtimeOnly("gg.jte:jte-spring-boot-starter-3:3.2.1")

    implementation 'org.postgresql:postgresql:42.7.5'

    implementation("org.apache.commons:commons-text:1.14.0")
    implementation("commons-io:commons-io:2.19.0")

    testImplementation("dev.langchain4j:langchain4j:1.3.0")
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
    useJUnitPlatform()
}

